name: Compilation Workflow

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:

  compilation:

    runs-on: ubuntu-20.04

    env:
      RIOTBASE: ${GITHUB_WORKSPACE}/RIOT

    steps:
    - name: Clone mcu-firmware
      uses: actions/checkout@v2
      with:
        path: 'mcu-firmware'
    - name: Clone RIOT
      uses: actions/checkout@v2
      with:
        repository: 'RIOT-OS/RIOT'
        ref: '2022.04'
        path: 'RIOT'
    - name: Install toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -qq build-essential gcc-multilib g++-multilib gcc-arm-none-eabi libnewlib-arm-none-eabi uncrustify protobuf-compiler
        gcc --version
        arm-none-eabi-gcc --version
    - name: Install Python packages
      run: |
        sudo apt-get install -qq python3-pip
        cd mcu-firmware
        python3 -m venv venv
        source venv/bin/activate
        python3 -m pip install -r requirements.txt
        deactivate
    - name: Compile
      run: |
        cd mcu-firmware
        source venv/bin/activate
        make
        deactivate
    - name: Distclean
      run: |
        cd mcu-firmware
        source venv/bin/activate
        make distclean
        deactivate
    - name: Re-compile (check successive builds)
      run: |
        cd mcu-firmware
        source venv/bin/activate
        make
        make
        deactivate
    - name: Clean all (distclean + git clean)
      run: |
        cd mcu-firmware
        source venv/bin/activate
        make distclean
        git clean -dxf
        deactivate
    - name: Check coding rules
      run: |
        cd mcu-firmware
        make check-codingrules
