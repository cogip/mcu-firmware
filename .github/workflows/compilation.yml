name: Compilation Workflow

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  check-commits:
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Check commit messages
      run: tools/check-branch-commits.sh ${{ github.event.pull_request.base.sha }}

  check-codingrules:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y uncrustify cppcheck
    - name: Check coding rules
      run: make check-codingrules

  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        board: [cogip-board, cogip-native]

    env:
      RIOTBASE: ${{ github.workspace }}/RIOT

    steps:
    - name: Setup git
      run: |
        git config --global user.email "cogip35@gmail.com"
        git config --global user.name "COGIP"

    - name: Clone mcu-firmware
      uses: actions/checkout@v4
      with:
        path: 'mcu-firmware'

    - name: Clone RIOT
      uses: actions/checkout@v4
      with:
        repository: 'cogip/RIOT'
        ref: 'cogip_master'
        path: 'RIOT'

    - name: Install toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-multilib g++-multilib \
          gcc-arm-none-eabi libnewlib-arm-none-eabi protobuf-compiler quilt

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: mcu-firmware/requirements.txt

    - name: Install Python packages
      run: pip install -r mcu-firmware/requirements.txt

    - name: Apply RIOT patches
      run: make -C mcu-firmware riot-patches

    - name: Build
      run: make -j$(nproc) -C mcu-firmware BOARD=${{ matrix.board }}
